name: Google Sheets Proxy

on:
  workflow_dispatch:
  repository_dispatch:

jobs:
  run-proxy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Run Google Sheets Proxy
        run: |
          echo "Starting Google Sheets Proxy..."

          node << 'EOF'
          const fetch = (...args) => import('node-fetch').then(({default: fetch}) => fetch(...args));

          const CLIENT_ID = process.env.GOOGLE_CLIENT_ID;
          const CLIENT_SECRET = process.env.GOOGLE_CLIENT_SECRET;
          const REFRESH_TOKEN = process.env.GOOGLE_REFRESH_TOKEN;

          async function getAccessToken() {
              const params = new URLSearchParams();
              params.append("client_id", CLIENT_ID);
              params.append("client_secret", CLIENT_SECRET);
              params.append("refresh_token", REFRESH_TOKEN);
              params.append("grant_type", "refresh_token");

              const res = await fetch("https://oauth2.googleapis.com/token", {
                  method: "POST",
                  headers: { "Content-Type": "application/x-www-form-urlencoded" },
                  body: params
              });

              const data = await res.json();
              console.log("TOKEN:", data);
          }

          getAccessToken();
          EOF

        env:
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          GOOGLE_REFRESH_TOKEN: ${{ secrets.GOOGLE_REFRESH_TOKEN }}
